# DCAM 生产环境部署指南

## 概述

本文档介绍如何在已有 Redmine 应用的云主机上部署 DCAM 系统，通过路径方式实现两个应用的共存，复用现有的域名和 SSL 证书。

## 部署架构

```
https://your-domain.com/          → Redmine 应用
https://your-domain.com/dcam/     → DCAM 应用
```

## 前提条件

- ✅ 云主机已运行 Redmine 应用
- ✅ 已配置域名解析和 SSL 证书
- ✅ Nginx 作为反向代理服务器
- ✅ Python 3.8+ 环境
- ✅ 具有 sudo 权限的用户账户

## 第一步：文件传输

### 1.1 压缩 DCAM 项目
在本地 Windows 环境执行：
```powershell
# 压缩 DCAM 项目（排除不必要文件）
Compress-Archive -Path "g:\DDND\OneDrive - DDN\DDN\code\DCAM\*" -DestinationPath "DCAM-deploy.zip" -Force
```

### 1.2 上传到服务器
```bash
# 使用 scp 上传文件
scp DCAM-deploy.zip user@your-server:/tmp/

# 或使用其他传输工具如 FileZilla、WinSCP 等
```

## 第二步：服务器端部署

### 2.1 解压和准备
```bash
# 登录到云主机
ssh user@your-server

# 解压文件
cd /tmp
unzip DCAM-deploy.zip -d DCAM/

# 移动到部署目录
sudo mkdir -p /opt/dcam
sudo mv DCAM/* /opt/dcam/
sudo chown -R www-data:www-data /opt/dcam
```

### 2.2 执行自动部署脚本
```bash
cd /opt/dcam
chmod +x deploy.sh
sudo ./deploy.sh
```

部署脚本将自动完成：
- 创建 Python 虚拟环境
- 安装依赖包
- 配置 systemd 服务
- 启动 DCAM 应用
- 生成 Nginx 配置模板

## 第三步：配置 Nginx

### 3.1 编辑现有 Nginx 配置
```bash
# 查找现有的 Nginx 配置文件
sudo nginx -T | grep "server_name your-domain.com" -B 5 -A 5

# 编辑主配置文件（通常在以下位置之一）
sudo nano /etc/nginx/sites-available/default
# 或
sudo nano /etc/nginx/sites-available/your-site-name
```

### 3.2 添加 DCAM 配置
在现有的 `server { listen 443 ssl; }` 块中添加以下内容：

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;  # 您的实际域名

    # 现有的 SSL 配置保持不变
    ssl_certificate /path/to/your/existing/cert.pem;
    ssl_certificate_key /path/to/your/existing/private.key;

    # 新增：DCAM 应用配置
    location /dcam/ {
        proxy_pass http://127.0.0.1:5001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        
        # 支持大文件上传
        client_max_body_size 100M;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
    }

    # 新增：DCAM 静态文件
    location /dcam/static/ {
        alias /opt/dcam/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 现有的 Redmine 配置保持不变
    location / {
        proxy_pass http://127.0.0.1:3000;  # 或您现有的配置
        # ... 其他现有配置
    }
}
```

### 3.3 测试并重新加载配置
```bash
# 测试 Nginx 配置语法
sudo nginx -t

# 如果测试通过，重新加载配置
sudo systemctl reload nginx
```

## 第四步：验证部署

### 4.1 检查服务状态
```bash
# 检查 DCAM 服务状态
sudo systemctl status dcam

# 查看服务日志
sudo journalctl -u dcam -f

# 检查端口监听
sudo netstat -tlnp | grep 5001
```

### 4.2 测试访问
```bash
# 测试本地访问
curl -I http://127.0.0.1:5001/

# 测试通过 Nginx 访问
curl -I https://your-domain.com/dcam/
```

### 4.3 浏览器验证
打开浏览器访问：
- **DCAM 应用**：`https://your-domain.com/dcam/`
- **Redmine 应用**：`https://your-domain.com/`（确保仍正常工作）

## 第五步：安全配置

### 5.1 防火墙设置
```bash
# 确保 5001 端口不对外开放（仅内部访问）
sudo ufw status
sudo ufw deny 5001/tcp  # 如果需要
```

### 5.2 文件权限
```bash
# 设置适当的文件权限
sudo chown -R www-data:www-data /opt/dcam
sudo chmod -R 755 /opt/dcam
sudo chmod 600 /opt/dcam/*.json  # 保护数据文件
```

### 5.3 修改默认密码
首次访问 DCAM 系统后：
1. 使用默认账户登录：`admin` / `admin123`
2. 立即修改为强密码
3. 创建其他必要的用户账户

## 第六步：备份配置

### 6.1 设置定时备份
```bash
# 编辑 crontab
sudo crontab -e

# 添加以下行（每天凌晨2点备份）
0 2 * * * /opt/dcam/backup.sh
```

### 6.2 手动备份测试
```bash
cd /opt/dcam
chmod +x backup.sh
./backup.sh
```

### 6.3 备份文件位置
```bash
# 查看备份文件
ls -la /opt/backups/dcam/
```

## 第七步：监控和维护

### 7.1 日志监控
```bash
# 实时查看 DCAM 应用日志
sudo journalctl -u dcam -f

# 查看 Nginx 访问日志
sudo tail -f /var/log/nginx/access.log | grep dcam

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

### 7.2 性能监控
```bash
# 检查系统资源使用
htop
df -h
free -h

# 检查 DCAM 进程
ps aux | grep gunicorn
```

### 7.3 应用更新流程
当需要更新 DCAM 应用时：
```bash
# 1. 备份当前版本
cd /opt/dcam
./backup.sh

# 2. 停止服务
sudo systemctl stop dcam

# 3. 更新代码文件
# （上传新版本文件到 /opt/dcam）

# 4. 重启服务
sudo systemctl start dcam
sudo systemctl reload nginx

# 5. 验证更新
sudo systemctl status dcam
curl -I https://your-domain.com/dcam/
```

## 故障排除

### 常见问题及解决方案

#### 问题1：DCAM 服务启动失败
```bash
# 检查错误日志
sudo journalctl -u dcam --no-pager -l

# 常见原因和解决方案：
# - 端口被占用：检查 netstat -tlnp | grep 5001
# - 权限问题：检查 /opt/dcam 目录权限
# - 依赖缺失：重新安装 pip install -r requirements.txt
```

#### 问题2：Nginx 502 错误
```bash
# 检查 DCAM 服务是否运行
sudo systemctl status dcam

# 检查端口连通性
telnet 127.0.0.1 5001

# 检查 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log
```

#### 问题3：文件上传失败
```bash
# 检查文件大小限制
grep client_max_body_size /etc/nginx/sites-available/*

# 检查磁盘空间
df -h /opt/dcam
```

#### 问题4：SSL 证书问题
```bash
# 验证证书有效性
openssl x509 -in /path/to/cert.pem -text -noout

# 检查证书过期时间
openssl x509 -in /path/to/cert.pem -noout -dates
```

## 系统要求和限制

### 最小系统要求
- **CPU**：1 核心
- **内存**：512MB（推荐 1GB+）
- **磁盘**：1GB 可用空间
- **网络**：稳定的网络连接

### 性能建议
- **CPU**：2+ 核心用于生产环境
- **内存**：2GB+ 用于处理大文件
- **磁盘**：SSD 存储提升性能
- **网络**：带宽充足支持文件上传

### 并发用户支持
- 当前配置支持约 10-20 并发用户
- 如需支持更多用户，可增加 Gunicorn workers：
```bash
# 编辑服务配置
sudo nano /etc/systemd/system/dcam.service

# 修改 ExecStart 行，增加 workers
ExecStart=/opt/dcam/venv/bin/gunicorn --bind 127.0.0.1:5001 --workers 5 --timeout 120 app:app
```

## 总结

通过本部署指南，您可以成功在现有 Redmine 服务器上部署 DCAM 系统，实现：

✅ **资源复用**：共享域名、SSL 证书和服务器资源  
✅ **服务隔离**：两个应用独立运行，互不影响  
✅ **统一访问**：通过同一域名的不同路径访问  
✅ **易于维护**：标准化的部署和维护流程  
✅ **安全可靠**：完整的备份和监控机制  

**访问地址**：
- DCAM 系统：`https://your-domain.com/dcam/`
- Redmine 系统：`https://your-domain.com/`（保持不变）

**技术支持**：如在部署过程中遇到问题，请参考故障排除部分或联系技术支持。