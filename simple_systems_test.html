<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç³»ç»Ÿç®¡ç† - å¿«é€ŸæŸ¥è¯¢æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .query-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-field { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, button { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        .results { margin-top: 20px; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 4px; display: none; }
        .log { background: #f1f1f1; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9em; max-height: 150px; overflow-y: auto; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¥ï¸ ç³»ç»Ÿç®¡ç† - å¿«é€ŸæŸ¥è¯¢åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="query-section">
            <h3>ğŸ” å¿«é€ŸæŸ¥è¯¢</h3>
            <form id="queryForm">
                <div class="form-row">
                    <div class="form-field">
                        <label>å®¢æˆ·</label>
                        <select id="customer_id" name="customer_id" onchange="updateSystemList()">
                            <option value="">æ‰€æœ‰å®¢æˆ·</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>ç³»ç»Ÿ</label>
                        <select id="system_id" name="system_id">
                            <option value="">æ‰€æœ‰ç³»ç»Ÿ</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>æŸ¥è¯¢ç±»å‹</label>
                        <select id="query_type" name="query_type" required>
                            <option value="">è¯·é€‰æ‹©æŸ¥è¯¢ç±»å‹</option>
                            <option value="0">æ‰€æœ‰æŸ¥è¯¢</option>
                            <option value="1">è®¾å¤‡æ•°é‡ç»Ÿè®¡</option>
                            <option value="2">SFAç‰ˆæœ¬è¯¦æƒ…</option>
                            <option value="3">EXAç‰ˆæœ¬è¯¦æƒ…</option>
                            <option value="4">ç³»ç»Ÿé…ç½®è¯¦æƒ…</option>
                        </select>
                    </div>
                    <div class="form-field" style="display: flex; gap: 10px;">
                        <button type="submit" style="flex: 1;">ğŸš€ æ‰§è¡ŒæŸ¥è¯¢</button>
                        <button type="button" onclick="resetForm()" style="flex: 1; background: #6c757d;">ğŸ”„ é‡ç½®</button>
                    </div>
                </div>
            </form>
            
            <div id="queryResults" class="results">
                <h4>æŸ¥è¯¢ç»“æœ</h4>
                <div id="resultsContent"></div>
            </div>
            
            <div class="log" id="log"><strong>æ“ä½œæ—¥å¿—:</strong><br></div>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateSystemList() {
            const customerSelect = document.getElementById('customer_id');
            const customerId = customerSelect.value;
            log(`æ›´æ–°ç³»ç»Ÿåˆ—è¡¨ï¼Œå®¢æˆ·ID: ${customerId}`);
            
            const url = customerId ? `/api/systems_by_customer?customer_id=${customerId}` : '/api/all_systems';
            log(`è¯·æ±‚URL: ${url}`);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    log(`è·å–åˆ° ${data.length} ä¸ªç³»ç»Ÿ`);
                    const select = document.getElementById('system_id');
                    while (select.options.length > 1) select.remove(1);
                    
                    data.forEach(system => {
                        const option = document.createElement('option');
                        option.value = system.id;
                        option.textContent = `${system.name} (${system.customer_name})`;
                        select.appendChild(option);
                    });
                })
                .catch(error => log(`ç³»ç»Ÿåˆ—è¡¨åŠ è½½å¤±è´¥: ${error.message}`));
        }

        function resetForm() {
            document.getElementById('queryForm').reset();
            document.getElementById('queryResults').style.display = 'none';
            updateSystemList();
            log('è¡¨å•å·²é‡ç½®');
        }

        function executeQuery() {
            const form = document.getElementById('queryForm');
            const formData = new FormData(form);
            const customerId = formData.get('customer_id');
            const systemId = formData.get('system_id');
            const queryType = formData.get('query_type');
            
            if (!queryType) {
                alert('è¯·é€‰æ‹©æŸ¥è¯¢ç±»å‹');
                return;
            }
            
            log(`æ‰§è¡ŒæŸ¥è¯¢: å®¢æˆ·=${customerId||'å…¨éƒ¨'}, ç³»ç»Ÿ=${systemId||'å…¨éƒ¨'}, ç±»å‹=${queryType}`);
            
            const resultsDiv = document.getElementById('queryResults');
            const contentDiv = document.getElementById('resultsContent');
            
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = 'â³ æ­£åœ¨æŸ¥è¯¢ä¸­...';
            
            const params = new URLSearchParams();
            if (customerId) params.append('customer_id', customerId);
            if (systemId) params.append('system_id', systemId);
            params.append('query_type', queryType);
            
            const queryUrl = `/query?${params.toString()}`;
            log(`æŸ¥è¯¢URL: ${queryUrl}`);
            
            fetch(queryUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const resultContent = doc.querySelector('.query-results');
                    
                    if (resultContent) {
                        contentDiv.innerHTML = resultContent.innerHTML;
                        log('æŸ¥è¯¢æˆåŠŸï¼Œç»“æœå·²æ˜¾ç¤º');
                    } else {
                        contentDiv.innerHTML = 'âŒ æŸ¥è¯¢ç»“æœæ ¼å¼é”™è¯¯';
                        log('æŸ¥è¯¢ç»“æœæ ¼å¼é”™è¯¯');
                    }
                })
                .catch(error => {
                    contentDiv.innerHTML = `âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`;
                    log(`æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                });
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åˆå§‹åŒ–å¼€å§‹');
            
            // åŠ è½½å®¢æˆ·åˆ—è¡¨
            fetch('/api/customers_list')
                .then(response => response.json())
                .then(data => {
                    log(`è·å–åˆ° ${data.length} ä¸ªå®¢æˆ·`);
                    const select = document.getElementById('customer_id');
                    data.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = customer.name;
                        select.appendChild(option);
                    });
                    updateSystemList();
                })
                .catch(error => log(`å®¢æˆ·åˆ—è¡¨åŠ è½½å¤±è´¥: ${error.message}`));
            
            // è¡¨å•æäº¤å¤„ç†
            document.getElementById('queryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                executeQuery();
            });
            
            log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>