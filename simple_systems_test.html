<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>系统管理 - 快速查询测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .query-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-field { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, button { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        .results { margin-top: 20px; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 4px; display: none; }
        .log { background: #f1f1f1; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9em; max-height: 150px; overflow-y: auto; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🖥️ 系统管理 - 快速查询功能测试</h1>
        
        <div class="query-section">
            <h3>🔍 快速查询</h3>
            <form id="queryForm">
                <div class="form-row">
                    <div class="form-field">
                        <label>客户</label>
                        <select id="customer_id" name="customer_id" onchange="updateSystemList()">
                            <option value="">所有客户</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>系统</label>
                        <select id="system_id" name="system_id">
                            <option value="">所有系统</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>查询类型</label>
                        <select id="query_type" name="query_type" required>
                            <option value="">请选择查询类型</option>
                            <option value="0">所有查询</option>
                            <option value="1">设备数量统计</option>
                            <option value="2">SFA版本详情</option>
                            <option value="3">EXA版本详情</option>
                            <option value="4">系统配置详情</option>
                        </select>
                    </div>
                    <div class="form-field" style="display: flex; gap: 10px;">
                        <button type="submit" style="flex: 1;">🚀 执行查询</button>
                        <button type="button" onclick="resetForm()" style="flex: 1; background: #6c757d;">🔄 重置</button>
                    </div>
                </div>
            </form>
            
            <div id="queryResults" class="results">
                <h4>查询结果</h4>
                <div id="resultsContent"></div>
            </div>
            
            <div class="log" id="log"><strong>操作日志:</strong><br></div>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateSystemList() {
            const customerSelect = document.getElementById('customer_id');
            const customerId = customerSelect.value;
            log(`更新系统列表，客户ID: ${customerId}`);
            
            const url = customerId ? `/api/systems_by_customer?customer_id=${customerId}` : '/api/all_systems';
            log(`请求URL: ${url}`);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    log(`获取到 ${data.length} 个系统`);
                    const select = document.getElementById('system_id');
                    while (select.options.length > 1) select.remove(1);
                    
                    data.forEach(system => {
                        const option = document.createElement('option');
                        option.value = system.id;
                        option.textContent = `${system.name} (${system.customer_name})`;
                        select.appendChild(option);
                    });
                })
                .catch(error => log(`系统列表加载失败: ${error.message}`));
        }

        function resetForm() {
            document.getElementById('queryForm').reset();
            document.getElementById('queryResults').style.display = 'none';
            updateSystemList();
            log('表单已重置');
        }

        function executeQuery() {
            const form = document.getElementById('queryForm');
            const formData = new FormData(form);
            const customerId = formData.get('customer_id');
            const systemId = formData.get('system_id');
            const queryType = formData.get('query_type');
            
            if (!queryType) {
                alert('请选择查询类型');
                return;
            }
            
            log(`执行查询: 客户=${customerId||'全部'}, 系统=${systemId||'全部'}, 类型=${queryType}`);
            
            const resultsDiv = document.getElementById('queryResults');
            const contentDiv = document.getElementById('resultsContent');
            
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = '⏳ 正在查询中...';
            
            const params = new URLSearchParams();
            if (customerId) params.append('customer_id', customerId);
            if (systemId) params.append('system_id', systemId);
            params.append('query_type', queryType);
            
            const queryUrl = `/query?${params.toString()}`;
            log(`查询URL: ${queryUrl}`);
            
            fetch(queryUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const resultContent = doc.querySelector('.query-results');
                    
                    if (resultContent) {
                        contentDiv.innerHTML = resultContent.innerHTML;
                        log('查询成功，结果已显示');
                    } else {
                        contentDiv.innerHTML = '❌ 查询结果格式错误';
                        log('查询结果格式错误');
                    }
                })
                .catch(error => {
                    contentDiv.innerHTML = `❌ 查询失败: ${error.message}`;
                    log(`查询失败: ${error.message}`);
                });
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('页面初始化开始');
            
            // 加载客户列表
            fetch('/api/customers_list')
                .then(response => response.json())
                .then(data => {
                    log(`获取到 ${data.length} 个客户`);
                    const select = document.getElementById('customer_id');
                    data.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = customer.name;
                        select.appendChild(option);
                    });
                    updateSystemList();
                })
                .catch(error => log(`客户列表加载失败: ${error.message}`));
            
            // 表单提交处理
            document.getElementById('queryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                executeQuery();
            });
            
            log('页面初始化完成');
        });
    </script>
</body>
</html>