<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="vie        .customer-systems {
            grid-area: systems;
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .query-section-full-width {
            width: 100%;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            margin: 30px 0;
            max-width: 1200px;
        } content="width=device-width, initial-scale=1.0">
    <title>{{ customer.name }} - å®¢æˆ·è¯¦æƒ… - DCAM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
            padding: 1.5rem 0;
            color: #2d3748;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a" cx="50%" cy="0%" r="100%"><stop offset="0%" stop-color="%23cf2e2e" stop-opacity=".05"/><stop offset="100%" stop-color="%23cf2e2e" stop-opacity="0"/></radialGradient></defs><rect width="100" height="20" fill="url(%23a)"/></svg>');
            opacity: 0.6;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .ddn-logo {
            height: 50px;
            width: auto;
            filter: none;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .breadcrumb {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .breadcrumb .separator {
            color: #a0aec0;
        }
        
        h1 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 2.2em;
        }
        
        h2 {
            color: #2d3748;
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }
        
        .subtitle {
            color: #4a5568;
            font-size: 1.1em;
        }
        
        .customer-top-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1.5rem;
        }
        
        .customer-info {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .customer-systems {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .info-item {
            margin-bottom: 1.5rem;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 0.3rem;
        }
        
        .info-value {
            font-size: 1.1rem;
            color: #2d3748;
        }
        
        .info-value.empty {
            color: #a0aec0;
            font-style: italic;
        }
        
        .description {
            padding: 1rem;
            background: #f7fafc;
            border-radius: 5px;
            color: #4a5568;
            margin-top: 0.5rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #edf2f7;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(226, 232, 240, 0.5);
        }
        
        .customer-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
        }
        
        .system-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .system-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .system-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .system-table th, .system-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .system-table th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
        }
        
        .system-table tbody tr:hover {
            background: #f7fafc;
        }
        
        .system-table a {
            color: #3182ce;
            text-decoration: none;
        }
        
        .system-table a:hover {
            text-decoration: underline;
        }
        
        .empty-systems {
            text-align: center;
            padding: 2rem;
            color: #a0aec0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-created {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .status-imported {
            background: #c6f6d5;
            color: #2f855a;
        }
        
        @media (max-width: 768px) {
            .customer-top-section {
                grid-template-columns: 1fr;
            }
            
            .query-section-full-width form > div {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='DDN-main-logo.svg') }}" alt="DDN Logo" class="ddn-logo">
                <div>
                    <h1>ğŸ¢ DCAM</h1>
                    <p class="subtitle">DDNå®¢æˆ·èµ„äº§ç®¡ç†ç³»ç»Ÿ</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="navigation">
            <div class="breadcrumb">
                <a href="{{ url_for('index') }}">é¦–é¡µ</a>
                <span class="separator">/</span>
                <a href="{{ url_for('customers_list') }}">å®¢æˆ·ç®¡ç†</a>
                <span class="separator">/</span>
                <span>{{ customer.name }}</span>
            </div>
        </div>
        
        <div class="customer-top-section">
            <div class="customer-info">
                <h2>å®¢æˆ·ä¿¡æ¯</h2>
                
                <div class="info-item">
                    <div class="info-label">å®¢æˆ·åç§°</div>
                    <div class="info-value">{{ customer.name }}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">è”ç³»äºº</div>
                    <div class="info-value {% if not customer.contact %}empty{% endif %}">
                        {{ customer.contact or 'æœªè®¾ç½®' }}
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">è”ç³»é‚®ç®±</div>
                    <div class="info-value {% if not customer.email %}empty{% endif %}">
                        {{ customer.email or 'æœªè®¾ç½®' }}
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">åˆ›å»ºæ—¶é—´</div>
                    <div class="info-value">
                        {{ customer.created_at|datetime }}
                    </div>
                </div>
                
                {% if customer.description %}
                <div class="info-item">
                    <div class="info-label">æè¿°</div>
                    <div class="description">{{ customer.description }}</div>
                </div>
                {% endif %}
                
                <div class="customer-actions">
                    <a href="{{ url_for('edit_customer', customer_id=customer_id) }}" class="btn btn-secondary">
                        <span class="icon">âœï¸</span>
                        ç¼–è¾‘å®¢æˆ·
                    </a>
                </div>
            </div>
            
            <div class="customer-systems">
                <div class="system-header">
                    <h2 class="system-title">å®¢æˆ·ç³»ç»Ÿ</h2>
                    <a href="{{ url_for('new_system') }}?customer_id={{ customer_id }}" class="btn btn-primary">
                        <span class="icon">â•</span>
                        æ·»åŠ ç³»ç»Ÿ
                    </a>
                </div>
                
                {% if systems %}
                    <table class="system-table">
                        <thead>
                            <tr>
                                <th>ç³»ç»Ÿåç§°</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for system_id, system in systems.items() %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('system_detail', system_id=system_id) }}">
                                            {{ system.name }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if system.status == 'created' %}
                                            <span class="status-badge status-created">å·²åˆ›å»º</span>
                                        {% elif system.status == 'imported' %}
                                            <span class="status-badge status-imported">å·²å¯¼å…¥</span>
                                        {% else %}
                                            <span class="status-badge">{{ system.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ system.created_at|datetime }}</td>
                                    <td>
                                        <a href="{{ url_for('system_detail', system_id=system_id) }}">æŸ¥çœ‹</a>
                                        {% if system.status == 'created' %}
                                         | <a href="{{ url_for('import_config', system_id=system_id) }}">å¯¼å…¥é…ç½®</a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-systems">
                        è¯¥å®¢æˆ·æš‚æ— ç³»ç»Ÿï¼Œç‚¹å‡»"æ·»åŠ ç³»ç»Ÿ"å¼€å§‹åˆ›å»º
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- å®¢æˆ·å¿«é€ŸæŸ¥è¯¢æ¥å£ - ç‹¬ç«‹å…¨å®½æ¨¡å— -->
        <div class="query-section-full-width">
                <h2 style="margin-bottom: 15px; color: #4a5568;">å®¢æˆ·èµ„äº§å¿«é€ŸæŸ¥è¯¢</h2>
                
                <form id="customerQueryForm" style="margin-bottom: 20px;">
                    <input type="hidden" id="customer_id" value="{{ customer_id }}">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px; width: 100%;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">èµ„äº§æ‰€æœ‰è€…</label>
                            <input type="text" value="{{ customer.name }}" disabled style="width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; background-color: #f8f9fa; color: #718096; box-sizing: border-box;">
                            <input type="hidden" id="asset_owner" name="asset_owner" value="{{ customer.name }}">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">ç³»ç»Ÿ</label>
                            <select id="system_id" name="system_id" style="width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; box-sizing: border-box;">
                                <option value="">æ‰€æœ‰ç³»ç»Ÿ</option>
                                {% for system_id, system in systems.items() %}
                                <option value="{{ system_id }}">{{ system.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">æŸ¥è¯¢ç±»å‹</label>
                            <select id="query_type" name="query_type" required style="width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; box-sizing: border-box;">
                                <option value="">è¯·é€‰æ‹©æŸ¥è¯¢ç±»å‹</option>
                                <option value="0">æ‰€æœ‰æŸ¥è¯¢</option>
                                <option value="1">è®¾å¤‡æ•°é‡ç»Ÿè®¡</option>
                                <option value="2">SFAç‰ˆæœ¬è¯¦æƒ…</option>
                                <option value="3">EXAç‰ˆæœ¬è¯¦æƒ…</option>
                                <option value="4">BBUè¿‡æœŸæ—¥æœŸè®¡ç®—</option>
                                <option value="5">é›†ç¾¤å®¹é‡æŸ¥è¯¢</option>
                                <option value="6">è®¾å¤‡åºåˆ—å·æŸ¥è¯¢</option>
                                <option value="7">é›†ç¾¤IPåœ°å€æŸ¥è¯¢</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <span class="icon">ğŸ”</span>
                        æ‰§è¡ŒæŸ¥è¯¢
                    </button>
                </form>
                
                <div id="customer-query-results" style="display: none; margin-top: 20px;">
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #4a5568;">æŸ¥è¯¢ç»“æœ</h4>
                    </div>
                    <div id="customer-results-container" style="overflow-x: auto;">
                        <!-- æŸ¥è¯¢ç»“æœå°†åœ¨æ­¤æ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
        document.addEventListener('DOMContentLoaded', function() {
            const dateElements = document.querySelectorAll('.info-value, td');
            dateElements.forEach(element => {
                const text = element.textContent.trim();
                if (text && text.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                    try {
                        const date = new Date(text);
                        element.textContent = date.toLocaleDateString('zh-CN') + ' ' + 
                                              date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
                    } catch (e) {
                        console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯', e);
                    }
                }
            });
            
            // å®¢æˆ·å¿«é€ŸæŸ¥è¯¢åŠŸèƒ½
            const customerQueryForm = document.getElementById('customerQueryForm');
            if (customerQueryForm) {
                console.log('æ‰¾åˆ°å®¢æˆ·æŸ¥è¯¢è¡¨å•ï¼Œæ·»åŠ æäº¤äº‹ä»¶ç›‘å¬å™¨');
                customerQueryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('è¡¨å•æäº¤è¢«è§¦å‘');
                    
                    // è·å–è¡¨å•æ•°æ®
                    const queryTypeElement = document.getElementById('query_type');
                    const assetOwnerElement = document.getElementById('asset_owner');
                    const systemIdElement = document.getElementById('system_id');
                    
                    if (!queryTypeElement || !queryTypeElement.value) {
                        alert('è¯·é€‰æ‹©æŸ¥è¯¢ç±»å‹');
                        return;
                    }
                    
                    const queryType = queryTypeElement.value;
                    const assetOwner = assetOwnerElement ? assetOwnerElement.value : '';
                    const systemId = systemIdElement ? systemIdElement.value : '';
                    
                    // è·å–ç»“æœå®¹å™¨å¹¶æ˜¾ç¤º
                    const queryResultsDiv = document.getElementById('customer-query-results');
                    const resultsContainerDiv = document.getElementById('customer-results-container');
                    
                    if (queryResultsDiv) {
                        queryResultsDiv.style.display = 'block';
                    }
                    
                    if (resultsContainerDiv) {
                        resultsContainerDiv.innerHTML = '<div style="text-align:center;padding:20px;">æ­£åœ¨åŠ è½½æŸ¥è¯¢ç»“æœ...</div>';
                    } else {
                        console.error('æœªæ‰¾åˆ°ç»“æœå®¹å™¨å…ƒç´ ');
                        return;
                    }
                    
                    // æ„å»ºæŸ¥è¯¢å‚æ•°
                    const params = new URLSearchParams();
                    params.append('query_type', queryType);
                    params.append('asset_owner', assetOwner);
                    if (systemId) params.append('system_id', systemId);
                    
                    console.log('æ­£åœ¨æ‰§è¡Œå®¢æˆ·æŸ¥è¯¢:', params.toString());
                    
                    // æ‰§è¡Œå…¨å±€æŸ¥è¯¢ï¼ˆä½¿ç”¨ä¸ä¸»é¡µç›¸åŒçš„APIï¼‰
                    const apiUrl = `/api/global_query?${params.toString()}`;
                    console.log('è¯·æ±‚URL:', apiUrl);
                    
                    fetch(apiUrl)
                        .then(response => {
                            console.log('APIå“åº”çŠ¶æ€:', response.status);
                            if (!response.ok) {
                                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('æŸ¥è¯¢è¿”å›æ•°æ®:', data);
                            if (!data) {
                                throw new Error('è¿”å›çš„æ•°æ®ä¸ºç©º');
                            }
                            displayCustomerQueryResults(data);
                        })
                        .catch(error => {
                            console.error('æŸ¥è¯¢å¤±è´¥:', error);
                            resultsContainerDiv.innerHTML = `<div style="color:#e53e3e;padding:15px;">æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
                        });
                });
            }
            
            // å¯¼å‡ºåŠŸèƒ½å·²ç§»é™¤
            
            // ä¿å­˜æ›´æ”¹åŠŸèƒ½
            const saveChangesBtn = document.getElementById('customer-save-changes');
            if (saveChangesBtn) {
                saveChangesBtn.addEventListener('click', function() {
                    const editedCells = document.querySelectorAll('td[data-edited="true"]');
                    if (editedCells.length === 0) {
                        alert('æ²¡æœ‰éœ€è¦ä¿å­˜çš„ä¿®æ”¹');
                        return;
                    }
                    
                    // æ”¶é›†ä¿®æ”¹æ•°æ®
                    const changes = [];
                    editedCells.forEach(cell => {
                        changes.push({
                            system_id: cell.dataset.systemId,
                            yaml_path: cell.dataset.path,
                            new_value: cell.textContent
                        });
                    });
                    
                    // å‘é€ä¿å­˜è¯·æ±‚
                    fetch('/api/update_yaml_fields', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ changes: changes })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('ä¿®æ”¹å·²ä¿å­˜');
                            // æ¸…é™¤å·²ç¼–è¾‘æ ‡è®°
                            editedCells.forEach(cell => cell.removeAttribute('data-edited'));
                        } else {
                            alert('ä¿å­˜å¤±è´¥: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('ä¿å­˜å¤±è´¥: ' + error.message);
                    });
                });
            }
        });
        
        // æ˜¾ç¤ºå®¢æˆ·æŸ¥è¯¢ç»“æœ
        function displayCustomerQueryResults(data) {
            console.log('å‡†å¤‡æ˜¾ç¤ºå®¢æˆ·æŸ¥è¯¢ç»“æœ:', data);
            const resultsContainerDiv = document.getElementById('customer-results-container');
            const queryResultsDiv = document.getElementById('customer-query-results');
            
            if (!resultsContainerDiv) {
                console.error('æœªæ‰¾åˆ°å®¢æˆ·æŸ¥è¯¢ç»“æœå®¹å™¨');
                return;
            }
            
            // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœåŒºåŸŸ
            if (queryResultsDiv) {
                queryResultsDiv.style.display = 'block';
            }
            
            // å¤„ç†é”™è¯¯æƒ…å†µ
            if (data.error) {
                resultsContainerDiv.innerHTML = `<div style="color:#e53e3e;padding:15px;">æŸ¥è¯¢é”™è¯¯: ${data.error}</div>`;
                return;
            }
            
            // å¤„ç†"æ‰€æœ‰æŸ¥è¯¢"ç±»å‹
            if (parseInt(data.query_type) === 0 && data.all_query_results) {
                console.log('å¤„ç†æ‰€æœ‰æŸ¥è¯¢ç±»å‹ç»“æœ');
                let allResultsHTML = '<h3 style="margin-bottom: 15px;">æ‰€æœ‰æŸ¥è¯¢ç»“æœ</h3>';
                
                for (const queryType in data.all_query_results) {
                    const queryResult = data.all_query_results[queryType];
                    queryResult.query_type = parseInt(queryType);
                    
                    let queryTypeName = '';
                    switch (parseInt(queryType)) {
                        case 1: queryTypeName = 'è®¾å¤‡æ•°é‡ç»Ÿè®¡'; break;
                        case 2: queryTypeName = 'SFAç‰ˆæœ¬è¯¦æƒ…'; break;
                        case 3: queryTypeName = 'EXAç‰ˆæœ¬è¯¦æƒ…'; break;
                        case 4: queryTypeName = 'BBUè¿‡æœŸæ—¥æœŸè®¡ç®—'; break;
                        case 5: queryTypeName = 'é›†ç¾¤å®¹é‡æŸ¥è¯¢'; break;
                        case 6: queryTypeName = 'è®¾å¤‡åºåˆ—å·æŸ¥è¯¢'; break;
                        case 7: queryTypeName = 'é›†ç¾¤IPåœ°å€æŸ¥è¯¢'; break;
                    }
                    
                    allResultsHTML += `<div style="margin-top: 30px;"><h4 style="margin-bottom: 10px;">${queryTypeName}</h4>`;
                    allResultsHTML += createCustomerQueryResultHTML(queryResult);
                    allResultsHTML += '</div>';
                }
                
                resultsContainerDiv.innerHTML = allResultsHTML;
            } else {
                // å•ä¸ªæŸ¥è¯¢ç±»å‹çš„ç»“æœ
                console.log('å¤„ç†å•ä¸ªæŸ¥è¯¢ç±»å‹ç»“æœ:', data.query_type);
                resultsContainerDiv.innerHTML = createCustomerQueryResultHTML(data);
            }
        }
        
        // åˆ›å»ºå®¢æˆ·æŸ¥è¯¢ç»“æœHTML
        function createCustomerQueryResultHTML(data) {
            console.log('å¼€å§‹åˆ›å»ºæŸ¥è¯¢ç»“æœHTMLï¼Œæ•°æ®ç±»å‹:', data.query_type);
            
            // å¦‚æœæ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (!data) {
                console.error('æŸ¥è¯¢ç»“æœæ•°æ®ä¸ºç©º');
                return '<div style="padding:15px;text-align:center;color:#718096;">æ— æŸ¥è¯¢ç»“æœæ•°æ®</div>';
            }
            
            // ç®€å•çš„è¡¨æ ¼é£æ ¼ - å‚ç…§åŸå§‹è„šæœ¬è¾“å‡º
            let resultHtml = '<table style="width:100%; border-collapse:collapse; font-family:monospace;">';
            
            // ç¡®å®šè¦æ˜¾ç¤ºå“ªäº›åˆ—
            let columns = [];
            let items = [];
            
            // å¤„ç†ä¸åŒæŸ¥è¯¢ç±»å‹çš„æ•°æ®ç»“æ„
            if (data.query_type == 1) {
                // è®¾å¤‡æ•°é‡ç»Ÿè®¡
                columns = ["é›†ç¾¤åç§°", "è®¾å¤‡æ•°é‡", "èµ„äº§æ‰€æœ‰è€…"];
                if (data.clusters && data.clusters.length > 0) {
                    items = data.clusters.map(c => [
                        c.Cluster_name || '-',
                        c.Device_count || 0,
                        c.Asset_owner || '-'
                    ]);
                    // æ·»åŠ æ€»è®¡è¡Œ
                    if (data.total_devices) {
                        items.push(['æ€»è®¡', data.total_devices, '']);
                    }
                }
            } else if (data.query_type == 2) {
                // SFAç‰ˆæœ¬è¯¦æƒ…
                columns = ["é›†ç¾¤åç§°", "è®¾å¤‡åç§°", "èµ„äº§æ‰€æœ‰è€…", "SFAç‰ˆæœ¬", "è®¾å¤‡ç±»å‹"];
                if (data.devices && data.devices.length > 0) {
                    items = data.devices.map(d => [
                        d.Cluster_name || '-',
                        d.Device_name || '-',
                        d.Asset_owner || '-',
                        d.SFA_version || '-',
                        d.Type || '-'
                    ]);
                }
            } else if (data.query_type == 3) {
                // EXAç‰ˆæœ¬è¯¦æƒ…
                columns = ["é›†ç¾¤åç§°", "èµ„äº§æ‰€æœ‰è€…", "EXAç‰ˆæœ¬"];
                if (data.clusters && data.clusters.length > 0) {
                    items = data.clusters.map(c => [
                        c.Cluster_name || '-',
                        c.Asset_owner || '-',
                        c.EXA_version || '-'
                    ]);
                }
            } else if (data.query_type == 4) {
                // BBUè¿‡æœŸæ—¥æœŸ
                columns = ["é›†ç¾¤åç§°", "è®¾å¤‡åç§°", "èµ„äº§æ‰€æœ‰è€…", "BBU1è¿‡æœŸæ—¥æœŸ", "BBU1å‰©ä½™å¤©æ•°", "BBU2è¿‡æœŸæ—¥æœŸ", "BBU2å‰©ä½™å¤©æ•°"];
                if (data.devices && data.devices.length > 0) {
                    items = data.devices.map(d => [
                        d.Cluster_name || '-',
                        d.Device_name || '-',
                        d.Asset_owner || '-',
                        d.BBU1_expiration || '-',
                        typeof d.BBU1_remaining_days === 'number' ? 
                          (d.BBU1_remaining_days >= 0 ? d.BBU1_remaining_days + ' å¤©' : 'å·²è¿‡æœŸ ' + (-d.BBU1_remaining_days) + ' å¤©') : '-',
                        d.BBU2_expiration || '-',
                        typeof d.BBU2_remaining_days === 'number' ? 
                          (d.BBU2_remaining_days >= 0 ? d.BBU2_remaining_days + ' å¤©' : 'å·²è¿‡æœŸ ' + (-d.BBU2_remaining_days) + ' å¤©') : '-'
                    ]);
                }
            } else if (data.query_type == 5) {
                // é›†ç¾¤å®¹é‡æŸ¥è¯¢
                columns = ["é›†ç¾¤åç§°", "èµ„äº§æ‰€æœ‰è€…", "ç½‘ç»œç«¯å£ç±»å‹", "å®¹é‡"];
                if (data.clusters && data.clusters.length > 0) {
                    items = data.clusters.map(c => [
                        c.Cluster_name || '-',
                        c.Asset_owner || '-',
                        c.Network_port_type || '-',
                        c.Capacity || '-'
                    ]);
                }
            } else if (data.query_type == 6) {
                // è®¾å¤‡åºåˆ—å·æŸ¥è¯¢
                columns = ["é›†ç¾¤åç§°", "è®¾å¤‡åç§°", "èµ„äº§æ‰€æœ‰è€…", "æ§åˆ¶å™¨C0åºåˆ—å·", "æ§åˆ¶å™¨C1åºåˆ—å·"];
                if (data.devices && data.devices.length > 0) {
                    items = data.devices.map(d => [
                        d.Cluster_name || '-',
                        d.Device_name || '-',
                        d.Asset_owner || '-',
                        d.Controller_c0_serial_number || '-',
                        d.Controller_c1_serial_number || '-'
                    ]);
                }
            } else if (data.query_type == 7) {
                // é›†ç¾¤IPåœ°å€æŸ¥è¯¢ï¼ˆåŒ…å«ä¸»æœºIPä¿¡æ¯ï¼‰
                columns = ["é›†ç¾¤åç§°", "è®¾å¤‡åç§°", "èµ„äº§æ‰€æœ‰è€…", "æ§åˆ¶å™¨C0 IP", "æ§åˆ¶å™¨C1 IP", "EMF IP", "ä¸»æœºå", "ä¸»æœºç®¡ç†IP", "ä¸»æœºæ•°æ®ç½‘ç»œ"];
                if (data.devices && data.devices.length > 0) {
                    items = data.devices.map(d => [
                        d.Cluster_name || '-',
                        d.Device_name || '-',
                        d.Asset_owner || '-',
                        d.Controller_c0_ip || '-',
                        d.Controller_c1_ip || '-',
                        d.EMF_ip || '-',
                        d.Host_name || '-',
                        d.Host_mgmt_ip || '-',
                        d.Host_data_networks || '-'
                    ]);
                }
            }
            
            // æ„å»ºè¡¨å¤´
            resultHtml += '<tr>';
            columns.forEach(col => {
                resultHtml += `<th style="text-align:left;padding:8px;border-bottom:2px solid #e2e8f0;background:#f7fafc;">${col}</th>`;
            });
            resultHtml += '</tr>';
            
            // æ„å»ºè¡¨æ ¼å†…å®¹
            if (items.length === 0) {
                resultHtml += `<tr><td colspan="${columns.length}" style="padding:10px;text-align:center;color:#718096;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®</td></tr>`;
            } else {
                items.forEach((row, rowIndex) => {
                    const rowStyle = rowIndex % 2 === 0 ? 'background:#f8fafc;' : '';
                    resultHtml += `<tr style="${rowStyle}">`;
                    row.forEach(cell => {
                        resultHtml += `<td style="padding:8px;border-bottom:1px solid #e2e8f0;">${cell}</td>`;
                    });
                    resultHtml += '</tr>';
                });
            }
            
            resultHtml += '</table>';
            
            // ç‰ˆæœ¬ç»Ÿè®¡æ‘˜è¦å·²ç§»é™¤
            
            return resultHtml;
        }
    </script>
</body>
</html>